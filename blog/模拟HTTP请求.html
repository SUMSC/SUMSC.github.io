<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>使用 Python3 urllib 模拟 HTTP 请求 | SUMSC</title>
    <meta name="description" content="这里是苏州大学微软学生俱乐部，在这里，你可以看到关于我们的信息以及我们最近的动态。">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <link rel="favicon" type="image/x-icon" href="./favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.6e1da392.css" as="style"><link rel="preload" href="/assets/js/app.3208c2b3.js" as="script"><link rel="preload" href="/assets/js/3.bd061ade.js" as="script"><link rel="preload" href="/assets/js/1.c282bb83.js" as="script"><link rel="preload" href="/assets/js/11.60b64a0c.js" as="script"><link rel="prefetch" href="/assets/js/10.9f49cdcb.js"><link rel="prefetch" href="/assets/js/12.0db49a6e.js"><link rel="prefetch" href="/assets/js/13.2efbe412.js"><link rel="prefetch" href="/assets/js/14.b4545ab3.js"><link rel="prefetch" href="/assets/js/15.58a3eba4.js"><link rel="prefetch" href="/assets/js/16.bcc1b39e.js"><link rel="prefetch" href="/assets/js/4.0e538e8d.js"><link rel="prefetch" href="/assets/js/5.c1b0ede5.js"><link rel="prefetch" href="/assets/js/6.64cbf517.js"><link rel="prefetch" href="/assets/js/7.4cdc0b6b.js"><link rel="prefetch" href="/assets/js/8.9f43c72f.js"><link rel="prefetch" href="/assets/js/9.7026262b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6e1da392.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="theme-container no-sidebar"><div><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">SUMSC</span></a> <div class="links"><div class="color-picker"><a href="#" class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="theme-options"><!----> <div class="dark-theme-options toggle-option"><label for="dark-theme-toggle">Enable Dark Theme?</label> <input id="dark-theme-toggle" type="checkbox" checked="checked"></div></div></div></div> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active"><i class="iconfont reco-date"></i>
  技术博客
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-account"></i>
      魔盒挑战
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pandora/2/" class="nav-link"><i class="iconfont undefined"></i>
  第二期
</a></li><li class="dropdown-item"><!----> <a href="/pandora/1/" class="nav-link"><i class="iconfont undefined"></i>
  第一期
</a></li></ul></div></div><div class="nav-item"><a href="/about.html" class="nav-link"><i class="iconfont reco-message"></i>
  关于我们
</a></div><div class="nav-item"><a href="https://github.com/SUMSC" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active"><i class="iconfont reco-date"></i>
  技术博客
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-account"></i>
      魔盒挑战
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pandora/2/" class="nav-link"><i class="iconfont undefined"></i>
  第二期
</a></li><li class="dropdown-item"><!----> <a href="/pandora/1/" class="nav-link"><i class="iconfont undefined"></i>
  第一期
</a></li></ul></div></div><div class="nav-item"><a href="/about.html" class="nav-link"><i class="iconfont reco-message"></i>
  关于我们
</a></div><div class="nav-item"><a href="https://github.com/SUMSC" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <!----> </aside> <div><main class="page reco-hide"> <div class="page-title"><h1>使用 Python3 urllib 模拟 HTTP 请求</h1> <hr> <div data-v-0b496ca7><i class="iconfont reco-account" data-v-0b496ca7><span data-v-0b496ca7>Amber</span></i> <i class="iconfont reco-date" data-v-0b496ca7><span data-v-0b496ca7>5/19/2019</span></i> <!----> <!----></div></div> <div class="content__default"><p>使用 Python3 Built-in 的 urllib 可以发送 HTTP 请求，虽然不如 <code>requests</code> 方便，但是用来做一些 <code>parse</code> 工作还是相当不错的。</p> <h2 id="urllib"><a href="#urllib" aria-hidden="true" class="header-anchor">#</a> urllib</h2> <p><code>urllib</code>有四个模块：</p> <ul><li><code>request</code>，处理请求；</li> <li><code>error</code>，处理错误；</li> <li><code>parse</code>，对请求内容解码和编码；</li> <li><code>robotparser</code>，检查<code>robot.txt</code>。</li></ul> <h3 id="发送请求"><a href="#发送请求" aria-hidden="true" class="header-anchor">#</a> 发送请求</h3> <p><code>request</code>用于发送请求。</p> <h4 id="urlopen"><a href="#urlopen" aria-hidden="true" class="header-anchor">#</a> <code>urlopen()</code></h4> <p>示例：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> urllib<span class="token punctuation">.</span>request

res <span class="token operator">=</span> urllib<span class="token punctuation">.</span>request<span class="token punctuation">.</span>urlopen<span class="token punctuation">(</span><span class="token string">&quot;https://www.python.org/&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># get html</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># &lt;class 'http.client.HTTPResponse'&gt;</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>getheader<span class="token punctuation">(</span><span class="token string">&quot;Server&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 'nginx'</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>getheaders<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># Response Headers</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>status<span class="token punctuation">)</span> <span class="token comment"># 200</span>
</code></pre></div><p>这个方法也支持表单提交。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> urllib<span class="token punctuation">.</span>request
<span class="token keyword">import</span> urllib<span class="token punctuation">.</span>parse

data <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>urllib<span class="token punctuation">.</span>parse<span class="token punctuation">.</span>urlencode<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;word&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;hi&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf8'</span><span class="token punctuation">)</span>
res <span class="token operator">=</span> urllib<span class="token punctuation">.</span>request<span class="token punctuation">.</span>urlopen<span class="token punctuation">(</span><span class="token string">&quot;https://httpbin.org/post&quot;</span><span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="request"><a href="#request" aria-hidden="true" class="header-anchor">#</a> <code>Request</code></h4> <p><code>Request</code>类可以生成完整的请求实例，添加 Headers，指定 Method。</p> <div class="language-python extra-class"><pre class="language-python"><code>url <span class="token operator">=</span> <span class="token string">&quot;http://httpbin.org/post&quot;</span>
headers <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;User-Agent&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6)&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;Host&quot;</span><span class="token punctuation">:</span> <span class="token string">'httpbin.org'</span>
<span class="token punctuation">}</span>
<span class="token builtin">dict</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'Amber'</span><span class="token punctuation">}</span>
data <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>urllib<span class="token punctuation">.</span>parse<span class="token punctuation">.</span>urlencode<span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf8'</span><span class="token punctuation">)</span>
req <span class="token operator">=</span> urllib<span class="token punctuation">.</span>request<span class="token punctuation">.</span>Request<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token string">'POST'</span><span class="token punctuation">)</span>
res <span class="token operator">=</span> urllib<span class="token punctuation">.</span>request<span class="token punctuation">.</span>urlopen<span class="token punctuation">(</span>req<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="高级用法"><a href="#高级用法" aria-hidden="true" class="header-anchor">#</a> 高级用法</h4> <p>生成一个请求，不仅仅会需要 URI、参数、方法和请求头，还需要处理 Cookie、代理等等。生成这样的高级请求就要用到<code>Handler</code>。<code>urllib.request.BaseHandler</code>提供了最基本的方法，可以集成它来自己创建<code>Handler</code>，有一些内置的：</p> <ul><li><code>HTTPDefaultErrorHandler</code></li> <li><code>HTTPRedirectHandler</code></li> <li><code>HTTPCookieProcessor</code></li> <li><code>ProxyHandle</code></li> <li><code>HTTPPasswordMgr</code></li> <li><code>HTTPBasicAuthHandler</code></li></ul> <p>还有一些其他的，可以查看文档。</p> <p>另外一个重要的类是<code>OpenerDirector</code>，简称<code>Opener</code>。<code>Opener</code>可以使用<code>open()</code>方法，返回<code>response</code>。我们需要利用<code>Handler</code>来构建<code>Opener</code>。</p> <h5 id="cookie"><a href="#cookie" aria-hidden="true" class="header-anchor">#</a> Cookie</h5> <p>下面是一个利用<code>HTTPCookieProcessor</code>读写 Cookie 的例子：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">build_cookie</span><span class="token punctuation">(</span>cookie_file<span class="token punctuation">,</span> login_req<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> override<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    将 Cookies 写入 cookie_file，或从其中读出 Cookies
    :param cookie_file: Cookie 文件路径
    :param login_req: 建立 Cookie 的请求
    :param override: 是否覆盖原先的 Cookie 文件
    :return: cookie_opener
    &quot;&quot;&quot;</span>
    <span class="token keyword">import</span> os
    <span class="token keyword">from</span> http<span class="token punctuation">.</span>cookiejar <span class="token keyword">import</span> LWPCookieJar
    <span class="token keyword">from</span> urllib<span class="token punctuation">.</span>request <span class="token keyword">import</span> HTTPCookieProcessor<span class="token punctuation">,</span> build_opener
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>cookie_file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">or</span> override<span class="token punctuation">:</span>
        <span class="token keyword">if</span> login_req <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">&quot;请给出登陆请求！&quot;</span><span class="token punctuation">)</span>
        cookie <span class="token operator">=</span> LWPCookieJar<span class="token punctuation">(</span>cookie_file<span class="token punctuation">)</span>
        cookie_opener <span class="token operator">=</span> build_opener<span class="token punctuation">(</span>HTTPCookieProcessor<span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">)</span>
        cookie_opener<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>login_req<span class="token punctuation">)</span>
        cookie<span class="token punctuation">.</span>save<span class="token punctuation">(</span>ignore_expires<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> ignore_discard<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># 直接读取</span>
        cookie <span class="token operator">=</span> LWPCookieJar<span class="token punctuation">(</span><span class="token punctuation">)</span>
        cookie<span class="token punctuation">.</span>load<span class="token punctuation">(</span>cookie_file<span class="token punctuation">,</span> ignore_discard<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> ignore_expires<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        cookie_opener <span class="token operator">=</span> build_opener<span class="token punctuation">(</span>HTTPCookieProcessor<span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> cookie_opener
</code></pre></div><h5 id="代理"><a href="#代理" aria-hidden="true" class="header-anchor">#</a> 代理</h5> <p>下面是一个利用<code>ProxyHandler</code>实现代理访问的方法：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">build_proxy</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    根据 proxy 参数获取代理访问
    :param proxy: dict，key 为协议，value 为代理地址
    :return: proxy_opener
    &quot;&quot;&quot;</span>
    <span class="token keyword">from</span> urllib<span class="token punctuation">.</span>request <span class="token keyword">import</span> ProxyHandler<span class="token punctuation">,</span> build_opener
    <span class="token keyword">return</span> build_opener<span class="token punctuation">(</span>ProxyHandler<span class="token punctuation">(</span>proxy<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="处理异常"><a href="#处理异常" aria-hidden="true" class="header-anchor">#</a> 处理异常</h3> <p><code>urllib</code>提供了<code>URLError</code>和<code>HTTPError</code>，所有<code>request</code>返回的异常都在<code>URLError</code>中。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> urllib <span class="token keyword">import</span> request<span class="token punctuation">,</span> error

<span class="token keyword">try</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> request<span class="token punctuation">.</span>urlopen<span class="token punctuation">(</span><span class="token string">'https://xxx.com/'</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> error<span class="token punctuation">.</span>HTTPError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>reason<span class="token punctuation">,</span> e<span class="token punctuation">.</span>code<span class="token punctuation">,</span> e<span class="token punctuation">.</span>headers<span class="token punctuation">)</span>
<span class="token keyword">except</span> error<span class="token punctuation">.</span>URLError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>reason<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Request Successfully'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="解析链接"><a href="#解析链接" aria-hidden="true" class="header-anchor">#</a> 解析链接</h3> <p>URL 中有一些很重要的信息，包括协议、域名、资源地址、参数、查询以及分段。使用<code>parse</code>模块可以对 URL 进行解析。</p> <ul><li><code>urlparse</code>可以将 URL 分为协议、域名、资源地址、参数、查询以及分段六块，<code>urlunparse</code>可以将一个六元素列表组织成一个 URL。</li> <li><code>urlsplit</code>无视参数项，分解为协议、域名、资源地址、查询以及分段五块，<code>urlunsplit</code>将一个五元素列表组织成一个 URL。</li> <li><code>urlencode</code>将一个字典编码为一个 GET 查询字符串。<code>parse_qs</code>将一个 GET 查询字符串解码为字典。</li> <li><code>quote</code>将字符串进行 URL 序列化，<code>unquote</code>反之。</li></ul> <h3 id="分析robots协议"><a href="#分析robots协议" aria-hidden="true" class="header-anchor">#</a> 分析<code>Robots</code>协议</h3> <p><code>robotparse</code>模块解析<code>robots.txt</code>，判断爬虫是否有权限对某个页面进行爬取。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">can_fetch</span><span class="token punctuation">(</span>ua<span class="token punctuation">,</span> url<span class="token punctuation">,</span> robots_url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    查看 UA 是否可以爬取该 URL
    :param ua: 爬虫 User-Agent
    :param url: 需要爬取的页面地址
    :param robots_url: 主站的 robots.txt
    :return: Bool
    &quot;&quot;&quot;</span>
    <span class="token keyword">from</span> urllib <span class="token keyword">import</span> parse<span class="token punctuation">,</span> robotparser
    robots <span class="token operator">=</span> robotparser<span class="token punctuation">.</span>RobotFileParser<span class="token punctuation">(</span>robots_url<span class="token punctuation">)</span>
    robots<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> robots<span class="token punctuation">.</span>can_fetch<span class="token punctuation">(</span>ua<span class="token punctuation">,</span> url<span class="token punctuation">)</span>
</code></pre></div><h2 id="requests"><a href="#requests" aria-hidden="true" class="header-anchor">#</a> requests</h2> <h3 id="基本用法"><a href="#基本用法" aria-hidden="true" class="header-anchor">#</a> 基本用法</h3> <p><code>requests</code>可以直接发起对应的 HTTP Method 请求：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> requests
url <span class="token operator">=</span> <span class="token string">&quot;https://www.baidu.com/&quot;</span>
requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
requests<span class="token punctuation">.</span>put<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
requests<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
requests<span class="token punctuation">.</span>options<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
</code></pre></div><h4 id="get"><a href="#get" aria-hidden="true" class="header-anchor">#</a> GET</h4> <p>对于 GET 参数，可以直接将字典附加到<code>requests.get()</code>的<code>params</code>参数。对于 API 返回的 JSON，可以直接调用<code>response.json()</code>。可以直接附加 Headers。<code>response</code>的<code>text</code>属性是 Unicode 解码，<code>content</code>属性是二进制。封装的<code>response</code>中还可以获取 Cookies，History，URL，Status_Code</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> requests
headers <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.99 Safari/537.36'</span>
<span class="token punctuation">}</span>
res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'https://www.zhihu.com/'</span><span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span>
</code></pre></div><h4 id="post"><a href="#post" aria-hidden="true" class="header-anchor">#</a> POST</h4> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> requests

data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'germey'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token string">'22'</span><span class="token punctuation">}</span>
r <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">&quot;http://httpbin.org/post&quot;</span><span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="高级用法-2"><a href="#高级用法-2" aria-hidden="true" class="header-anchor">#</a> 高级用法</h3> <h4 id="文件上传"><a href="#文件上传" aria-hidden="true" class="header-anchor">#</a> 文件上传</h4> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> requests

files <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'file'</span><span class="token punctuation">:</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'favicon.ico'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
r <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">&quot;http://httpbin.org/post&quot;</span><span class="token punctuation">,</span> files<span class="token operator">=</span>files<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
</code></pre></div><h4 id="cookie-2"><a href="#cookie-2" aria-hidden="true" class="header-anchor">#</a> Cookie</h4> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> requests

res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;https://www.baidu.com/&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>cookies<span class="token punctuation">)</span>
<span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> r<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> <span class="token string">'='</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span>
</code></pre></div><p>在<code>requests</code>中使用 Cookie，可以像往常一样直接放在 Headers 中，不过稍微有些难看，下面是完整的使用 Cookie 的方式：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> requests
<span class="token keyword">from</span> http<span class="token punctuation">.</span>cookiejar <span class="token keyword">import</span> LWPCookieJar

jar <span class="token operator">=</span> requests<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>RequestsCookieJar<span class="token punctuation">(</span><span class="token punctuation">)</span>
cookie <span class="token operator">=</span> LWPCookieJar<span class="token punctuation">(</span><span class="token punctuation">)</span>
cookie<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">&quot;cookie.txt&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> cookie<span class="token punctuation">:</span>
    jar<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>name<span class="token punctuation">,</span> i<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
</code></pre></div><h4 id="session"><a href="#session" aria-hidden="true" class="header-anchor">#</a> Session</h4> <p>上面的维持 Cookie 发起访问的方式相当麻烦，所以<code>requests</code>提供了更好的方法：Session。对于浏览器来说，会话（Session）是无比平常的东西。如果留心的话，在解析网络时经常能发现 Request Headers 总会有<code>keep-alive</code>。事实上，会话是依赖于 Cookie 的，由于 HTTP 是无状态协议，所以使用 Cookie 来标记长连接，也就是会话。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> requests

s <span class="token operator">=</span> requests<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;https://www.baidu.com&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>会话可以看作是<code>urllib</code>的一个 Opener，在一次会话中，会保留 Cookie、代理，因而非常方便。</p> <h4 id="ssl-证书"><a href="#ssl-证书" aria-hidden="true" class="header-anchor">#</a> SSL 证书</h4> <p><code>requests</code>提供了 SSL 证书验证的功能，如果遇到无法验证的 SSL 证书，可以添加<code>verify=False</code>跳过验证。</p> <h4 id="代理-2"><a href="#代理-2" aria-hidden="true" class="header-anchor">#</a> 代理</h4> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> requests

proxies <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'http'</span><span class="token punctuation">:</span> <span class="token string">'http://127.0.0.1:1087'</span><span class="token punctuation">,</span>
    <span class="token string">'https'</span><span class="token punctuation">:</span> <span class="token string">'https://127.0.0.1:1087'</span>
<span class="token punctuation">}</span>

proxies_socks <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'http'</span><span class="token punctuation">:</span> <span class="token string">'socks5://127.0.0.1:1086'</span><span class="token punctuation">,</span>
    <span class="token string">'https'</span><span class="token punctuation">:</span> <span class="token string">'socks5://127.0.0.1:1086'</span>
<span class="token punctuation">}</span>

requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;https://www.google.com&quot;</span><span class="token punctuation">,</span> proxies<span class="token operator">=</span>proxies<span class="token punctuation">)</span>
</code></pre></div><h4 id="prepared-request"><a href="#prepared-request" aria-hidden="true" class="header-anchor">#</a> Prepared Request</h4> <p>有可能我们需要一个结构化的请求来多次复用，这时候我们可以使用<code>Request</code>类来生成一个底层的请求对象。一个请求对象可以自己与处理，但是当使用<code>Session</code>时，就需要使用<code>Session</code>去预处理。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> requests <span class="token keyword">import</span> Request<span class="token punctuation">,</span> Session

url <span class="token operator">=</span> <span class="token string">'http://httpbin.reg/post'</span>
data <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'germey'</span>
<span class="token punctuation">}</span>
headers <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.99 Safari/537.36'</span>
<span class="token punctuation">}</span>
s <span class="token operator">=</span> Session<span class="token punctuation">(</span><span class="token punctuation">)</span>
req <span class="token operator">=</span> Request<span class="token punctuation">(</span><span class="token string">'POST'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span>
<span class="token comment"># pre_req = req.prepare()</span>
pre_req <span class="token operator">=</span> s<span class="token punctuation">.</span>prepare_request<span class="token punctuation">(</span>req<span class="token punctuation">)</span>
res <span class="token operator">=</span> s<span class="token punctuation">.</span>send<span class="token punctuation">(</span>pre_req<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
</code></pre></div><h2 id="正则"><a href="#正则" aria-hidden="true" class="header-anchor">#</a> 正则</h2> <p>完整讲述正则表达式过于复杂，不如自己理解。常用的正则表达式工具列在下方：</p> <ul><li><a href="http://tool.oschina.net/regex" target="_blank" rel="noopener noreferrer">正则表达式测试——开源中国<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://tool.oschina.net/uploads/apidocs/jquery/regexp.html" target="_blank" rel="noopener noreferrer">正则表达式手册——开源中国<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://deerchao.net/tutorials/regex/regex.htm" target="_blank" rel="noopener noreferrer">正则表达式入门教程<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>这里我们来说一些 Python3 re 模块的一些使用。</p> <h3 id="常用函数"><a href="#常用函数" aria-hidden="true" class="header-anchor">#</a> 常用函数</h3> <h4 id="修饰符"><a href="#修饰符" aria-hidden="true" class="header-anchor">#</a> 修饰符</h4> <ul><li><code>re.S</code>：使<code>.</code>匹配换行符在内的所有字符；</li> <li><code>re.I</code>：大小写不敏感；</li> <li><code>re.M</code>：多行匹配，影响<code>^</code>和<code>$</code>；</li> <li><code>re.L</code>：本地化识别匹配；</li> <li><code>re.U</code>：根据 Unicode 解析字符；</li> <li><code>re.X</code>：可以更灵活地写正则表达式。</li></ul> <p>一般常用<code>re.S</code>和<code>re.I</code>。</p> <h4 id="match"><a href="#match" aria-hidden="true" class="header-anchor">#</a> <code>match()</code></h4> <p>从字符串起始处开始匹配，返回一个<code>match</code>对象，可以使用<code>.group()</code>获取匹配到的内容。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> re

url <span class="token operator">=</span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token string">&quot;.*?&lt;title&gt;(.*?)&lt;/title&gt;&quot;</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># Google </span>
</code></pre></div><h4 id="search"><a href="#search" aria-hidden="true" class="header-anchor">#</a> <code>search()</code></h4> <p>和<code>match()</code>很像，区别是不是固定从开头开始查找。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> re

res <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'&lt;title&gt;(.*?)&lt;/title&gt;'</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="findall"><a href="#findall" aria-hidden="true" class="header-anchor">#</a> <code>findall()</code></h4> <p>获取所有正则能匹配到的内容。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> re

res <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'&lt;a.*?href=&quot;(.*?)&quot;'</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
</code></pre></div><h4 id="sub"><a href="#sub" aria-hidden="true" class="header-anchor">#</a> <code>sub()</code></h4> <p>用正则表达式统一替换。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> re

content <span class="token operator">=</span> <span class="token string">'123abc456'</span>
content <span class="token operator">=</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">'\d+'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span> <span class="token comment"># abc</span>
</code></pre></div><h4 id="compile"><a href="#compile" aria-hidden="true" class="header-anchor">#</a> <code>compile()</code></h4> <p>获取一个组织完成的正则表达式对象，便于复用。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> re

pattern <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span><span class="token string">'ppp.*?ppp'</span><span class="token punctuation">,</span> re<span class="token punctuation">.</span>S<span class="token punctuation">)</span>
</code></pre></div></div> <!----> <footer class="page-edit"><!----> <!----></footer> <!----> </main> <div class="valine-wrapper" data-v-0162251c><div id="valine" data-v-0162251c></div></div></div> <div class="back-to-ceiling" style="right:1rem;bottom:3rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;background-color:rgba(231, 234, 241,.5);display:none;" data-v-d0bfeaa4 data-v-d0bfeaa4><i class="iconfont reco-up" data-v-d0bfeaa4></i></div></div></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3208c2b3.js" defer></script><script src="/assets/js/3.bd061ade.js" defer></script><script src="/assets/js/1.c282bb83.js" defer></script><script src="/assets/js/11.60b64a0c.js" defer></script>
  </body>
</html>
